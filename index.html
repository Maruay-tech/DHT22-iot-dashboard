<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸŒ¡ï¸ ESP8266 Temp & Humidity Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    google.charts.load('current', { packages: ['corechart'] });
    let globalData;
    let scrollIndex = 0;
    const windowSize = 20;
    let currentTheme = 'dark';
    let selectedRange = 1;
    let autoScroll = true;

    function initDashboard() {
      drawChart();
      updateClock();
      setInterval(() => {
        if (autoScroll) drawChart(selectedRange, true);
      }, 3000);
      setInterval(updateClock, 1000);
    }

    google.charts.setOnLoadCallback(initDashboard);

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString();
    }

    function toggleScroll() {
      autoScroll = !autoScroll;
      document.getElementById("toggleScrollBtn").textContent = autoScroll ? "â¸ï¸ Pause" : "â–¶ï¸ Resume";
    }

    function setTheme(select) {
      currentTheme = select.value;
      document.body.className = currentTheme;
    }

    function filterData(days = 1) {
      if (!globalData) return;
      const now = new Date();
      const rangeTime = now.getTime() - days * 24 * 60 * 60 * 1000;
      const filteredData = new google.visualization.DataTable();
      filteredData.addColumn('datetime', 'Time');
      filteredData.addColumn('number', 'Temperature');
      filteredData.addColumn('number', 'Humidity');
      filteredData.addColumn({type: 'string', role: 'tooltip', p: {html: true}});
      filteredData.addColumn({type: 'string', role: 'tooltip', p: {html: true}});

      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0));
        if (time.getTime() >= rangeTime) {
          const temp = globalData.getValue(i, 1);
          const hum = globalData.getValue(i, 2);
          const tooltipTemp = `<div style='padding:5px'><b>ğŸŒ¡ï¸ Temperature:</b> ${temp.toFixed(2)} Â°C<br><i>${time.toLocaleTimeString()}</i></div>`;
          const tooltipHum = `<div style='padding:5px'><b>ğŸ’§ Humidity:</b> ${hum.toFixed(2)} %<br><i>${time.toLocaleTimeString()}</i></div>`;
          filteredData.addRow([time, temp, hum, tooltipTemp, tooltipHum]);
        }
      }

      return filteredData;
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const chartArea = document.createElement('div');
      chartArea.style.width = '900px';
      chartArea.style.padding = '10px';
      const clone1 = document.getElementById('chart_hum').cloneNode(true);
      const clone2 = document.getElementById('chart_temp').cloneNode(true);
      chartArea.appendChild(clone1);
      chartArea.appendChild(clone2);
      document.body.appendChild(chartArea);
      html2canvas(chartArea).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 5, 5, 200, 150);
        pdf.save('dashboard.pdf');
        document.body.removeChild(chartArea);
      });
    }

    function exportCSV() {
      if (!globalData) return;
      let csv = 'Timestamp,Temperature,Humidity\n';
      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0)).toISOString();
        const temp = globalData.getValue(i, 1);
        const hum = globalData.getValue(i, 2);
        csv += `${time},${temp},${hum}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'temperature_humidity_data.csv');
    }

    function drawChart(range = 1, scroll = false) {
      selectedRange = range;
      const query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/1sPCqSO142HEMHs4M_lzzEVFTDGchk7GkRILvnzwI3UM/gviz/tq?sheet=Sheet1&headers=1'
      );
      query.send(response => {
        if (response.isError()) return alert('Error: ' + response.getMessage());
        globalData = response.getDataTable();
        const filtered = filterData(range);

        const lastRow = filtered.getNumberOfRows() - 1;
        const temp = filtered.getValue(lastRow, 1);
        const hum = filtered.getValue(lastRow, 2);

        document.getElementById("latestTemp").textContent = `${temp.toFixed(2)} Â°C`;
        document.getElementById("latestHum").textContent = `${hum.toFixed(2)} %`;

        const tempData = new google.visualization.DataTable();
        tempData.addColumn('datetime', 'Time');
        tempData.addColumn('number', 'Temperature');
        tempData.addColumn({type: 'string', role: 'tooltip', p: {html: true}});

        const humData = new google.visualization.DataTable();
        humData.addColumn('datetime', 'Time');
        humData.addColumn('number', 'Humidity');
        humData.addColumn({type: 'string', role: 'tooltip', p: {html: true}});

        for (let i = 0; i < filtered.getNumberOfRows(); i++) {
          const time = filtered.getValue(i, 0);
          const t = filtered.getValue(i, 1);
          const h = filtered.getValue(i, 2);
          const tt = filtered.getValue(i, 3);
          const hh = filtered.getValue(i, 4);
          tempData.addRow([time, t, tt]);
          humData.addRow([time, h, hh]);
        }

        const commonOptions = {
          backgroundColor: 'transparent',
          legend: 'none',
          chartArea: { width: '85%', height: '65%' },
          hAxis: { title: 'à¹€à¸§à¸¥à¸²', format: 'HH:mm', direction: -1 },
          animation: { startup: true, duration: 800, easing: 'inAndOut' },
          tooltip: { isHtml: true },
          annotations: {
            alwaysOutside: true,
            textStyle: { fontSize: 12, color: '#000' }
          }
        };

        const tempOptions = Object.assign({}, commonOptions, {
          title: 'Temperature (Â°C)',
          vAxis: { title: 'Â°C' },
          series: { 0: { color: '#ff5252' } }
        });

        const humOptions = Object.assign({}, commonOptions, {
          title: 'Humidity (%)',
          vAxis: { title: '%' },
          series: { 0: { color: '#40c4ff' } }
        });

        new google.visualization.LineChart(document.getElementById('chart_hum')).draw(humData, humOptions);
        new google.visualization.LineChart(document.getElementById('chart_temp')).draw(tempData, tempOptions);
      });
    }
  </script>
</head>
<body class="dark">
  <h1>ğŸ“Š ESP8266 Temperature & Humidity Dashboard</h1>
  <p class="description">à¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸ 10 à¸§à¸´à¸™à¸²à¸—à¸µ | ğŸ•’ <span id="clock">--:--:--</span></p>
  <div id="controls">
    <button onclick="drawChart(1)">ğŸ“… 1 à¸§à¸±à¸™</button>
    <button onclick="drawChart(7)">ğŸ“… 7 à¸§à¸±à¸™</button>
    <button onclick="drawChart(7)">ğŸ“… 15 à¸§à¸±à¸™</button>
    <button onclick="exportCSV()">ğŸ“¤ Export CSV</button>
    <button onclick="exportPDF()">ğŸ“„ Export PDF</button>
    <select onchange="setTheme(this)">
      <option value="dark" selected>ğŸŒ™ Dark</option>
      <option value="light">ğŸ”† Light</option>
      <option value="blue">ğŸ”µ Blue</option>
      <option value="red">ğŸ”´ Red</option>
      <option value="green">ğŸŸ¢ Green</option>
      <option value="purple">ğŸŸ£ Purple</option>
      <option value="yellow">ğŸŸ¡ Yellow</option>
    </select>
    <button onclick="toggleScroll()" id="toggleScrollBtn">â¸ï¸ Pause</button>
  </div>
  <div id="latestValues">
    <div>à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´: <span id="latestTemp">-- Â°C</span></div>
    <div>à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™: <span id="latestHum">-- %</span></div>
  </div>
  <div class="chart-container" id="chart_hum"></div>
  <div class="chart-container" id="chart_temp"></div>
</body>
</html>
