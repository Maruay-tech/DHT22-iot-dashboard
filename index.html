<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üå°Ô∏è ESP8266 Temp & Humidity Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    google.charts.load('current', { packages: ['corechart'] });
    let globalData;
    let scrollIndex = 0;
    const windowSize = 20; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

    function initDashboard() {
      drawChart();
      setInterval(drawChart, 10000);
      setInterval(() => drawChart(undefined, true), 3000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }

    google.charts.setOnLoadCallback(initDashboard);

    function filterData(days = 1) {
      if (!globalData) return;
      const now = new Date();
      const rangeTime = now.getTime() - days * 24 * 60 * 60 * 1000;
      const filteredData = new google.visualization.DataTable();
      filteredData.addColumn('datetime', 'Time');
      filteredData.addColumn('number', 'Temperature');
      filteredData.addColumn('number', 'Humidity');

      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0));
        if (time.getTime() >= rangeTime) {
          filteredData.addRow([
            time,
            globalData.getValue(i, 1),
            globalData.getValue(i, 2)
          ]);
        }
      }

      return filteredData;
    }

    function exportCSV() {
      if (!globalData) return;
      let csv = 'Timestamp,Temperature,Humidity\n';
      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0)).toISOString();
        const temp = globalData.getValue(i, 1);
        const hum = globalData.getValue(i, 2);
        csv += `${time},${temp},${hum}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'temperature_humidity_data.csv');
    }

    function drawChart(range = 1, scroll = false) {
      const query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/1sPCqSO142HEMHs4M_lzzEVFTDGchk7GkRILvnzwI3UM/gviz/tq?sheet=Sheet1&headers=1'
      );
      query.send(response => {
        if (response.isError()) return alert('Error: ' + response.getMessage());
        globalData = response.getDataTable();
        const filtered = filterData(range);

        const lastRow = filtered.getNumberOfRows() - 1;
        const temp = filtered.getValue(lastRow, 1);
        const hum = filtered.getValue(lastRow, 2);

        document.getElementById("latestTemp").textContent = `${temp.toFixed(2)} ¬∞C`;
        document.getElementById("latestHum").textContent = `${hum.toFixed(2)} %`;

        let scrollData = new google.visualization.DataTable();
        scrollData.addColumn('datetime', 'Time');
        scrollData.addColumn('number', 'Temperature');
        scrollData.addColumn('number', 'Humidity');

        const totalRows = filtered.getNumberOfRows();
        if (scroll) scrollIndex++;
        if (scrollIndex > totalRows - windowSize) scrollIndex = 0;

        for (let i = scrollIndex; i < scrollIndex + windowSize && i < totalRows; i++) {
          scrollData.addRow([
            filtered.getValue(i, 0),
            filtered.getValue(i, 1),
            filtered.getValue(i, 2)
          ]);
        }

        const options = {
          backgroundColor: 'transparent',
          chartArea: { width: '85%', height: '65%' },
          legend: { position: 'bottom' },
          hAxis: {
            title: '‡πÄ‡∏ß‡∏•‡∏≤',
            format: 'HH:mm dd/MM',
            slantedText: true,
          },
          vAxes: {
            0: { title: 'Temp (¬∞C)' },
            1: { title: 'Humidity (%)' }
          },
          series: {
            0: { targetAxisIndex: 0, color: '#ff5252', lineWidth: 2 },
            1: { targetAxisIndex: 1, color: '#40c4ff', lineWidth: 2 }
          },
          height: 400,
          animation: { startup: true, duration: 500, easing: 'out' },
        };

        new google.visualization.LineChart(document.getElementById('chart_div')).draw(scrollData, options);
      });
    }
  </script>
  <style>
    body {
      background-color: #121212;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #fff;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .description {
      margin-bottom: 25px;
      color: #aaa;
    }
    #controls {
      margin-bottom: 20px;
    }
    #controls button {
      background: #1e88e5;
      border: none;
      padding: 8px 16px;
      color: #fff;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    #latestValues {
      display: flex;
      gap: 40px;
      margin: 20px 0;
    }
    .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    #chart_div {
      width: 100%;
      max-width: 900px;
    }
    @media (max-width: 600px) {
      #latestValues {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <h1>üìä ESP8266 Temperature & Humidity Dashboard</h1>
  <p class="description">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
  <div id="controls" role="region" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">
    <button onclick="drawChart(1)">üìÖ 1 ‡∏ß‡∏±‡∏ô</button>
    <button onclick="drawChart(7)">üìÖ 7 ‡∏ß‡∏±‡∏ô</button>
    <button onclick="exportCSV()">üì§ Export CSV</button>
  </div>
  <div id="latestValues" role="region" aria-live="polite">
    <div>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <span id="latestTemp" class="value">-- ¬∞C</span></div>
    <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: <span id="latestHum" class="value">-- %</span></div>
  </div>
  <div id="chart_div" role="img" aria-label="‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á"></div>
</body>
</html>
