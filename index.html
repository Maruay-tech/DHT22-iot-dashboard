<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üå°Ô∏è ESP8266 Temp & Humidity Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    google.charts.load('current', { packages: ['corechart'] });
    let globalData;
    let scrollIndex = 0;
    const windowSize = 20;
    let currentTheme = 'dark';
    let selectedRange = 1;

    function initDashboard() {
      drawChart();
      setInterval(() => drawChart(selectedRange, true), 3000); // smooth scroll every 3s
    }

    google.charts.setOnLoadCallback(initDashboard);

    function setTheme(theme) {
      currentTheme = theme;
      document.body.className = theme;
    }

    function filterData(days = 1) {
      if (!globalData) return;
      const now = new Date();
      const rangeTime = now.getTime() - days * 24 * 60 * 60 * 1000;
      const filteredData = new google.visualization.DataTable();
      filteredData.addColumn('datetime', 'Time');
      filteredData.addColumn('number', 'Temperature');
      filteredData.addColumn('number', 'Humidity');

      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0));
        if (time.getTime() >= rangeTime) {
          filteredData.addRow([
            time,
            globalData.getValue(i, 1),
            globalData.getValue(i, 2)
          ]);
        }
      }

      return filteredData;
    }

    function exportCSV() {
      if (!globalData) return;
      let csv = 'Timestamp,Temperature,Humidity\n';
      for (let i = 0; i < globalData.getNumberOfRows(); i++) {
        const time = new Date(globalData.getValue(i, 0)).toISOString();
        const temp = globalData.getValue(i, 1);
        const hum = globalData.getValue(i, 2);
        csv += `${time},${temp},${hum}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'temperature_humidity_data.csv');
    }

    function drawChart(range = 1, scroll = false) {
      selectedRange = range;
      const query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/1sPCqSO142HEMHs4M_lzzEVFTDGchk7GkRILvnzwI3UM/gviz/tq?sheet=Sheet1&headers=1'
      );
      query.send(response => {
        if (response.isError()) return alert('Error: ' + response.getMessage());
        globalData = response.getDataTable();
        const filtered = filterData(range);

        const lastRow = filtered.getNumberOfRows() - 1;
        const temp = filtered.getValue(lastRow, 1);
        const hum = filtered.getValue(lastRow, 2);

        document.getElementById("latestTemp").textContent = `${temp.toFixed(2)} ¬∞C`;
        document.getElementById("latestHum").textContent = `${hum.toFixed(2)} %`;

        let scrollData = new google.visualization.DataTable();
        scrollData.addColumn('datetime', 'Time');
        scrollData.addColumn('number', 'Temperature');
        scrollData.addColumn('number', 'Humidity');

        const totalRows = filtered.getNumberOfRows();
        if (scroll) scrollIndex++;
        if (scrollIndex > totalRows - windowSize) scrollIndex = 0;

        for (let i = scrollIndex; i < scrollIndex + windowSize && i < totalRows; i++) {
          scrollData.addRow([
            filtered.getValue(i, 0),
            filtered.getValue(i, 1),
            filtered.getValue(i, 2)
          ]);
        }

        const temps = scrollData.getFilteredRows([{ column: 1 }]).map(i => scrollData.getValue(i, 1));
        const hums = scrollData.getFilteredRows([{ column: 2 }]).map(i => scrollData.getValue(i, 2));
        const maxTemp = Math.max(...temps);
        const minTemp = Math.min(...temps);
        const maxHum = Math.max(...hums);
        const minHum = Math.min(...hums);

        document.getElementById("minMaxInfo").textContent = `üå°Ô∏è Max Temp: ${maxTemp.toFixed(1)}¬∞C / Min Temp: ${minTemp.toFixed(1)}¬∞C | üíß Max Hum: ${maxHum.toFixed(1)}% / Min Hum: ${minHum.toFixed(1)}%`;

        const options = {
          backgroundColor: 'transparent',
          chartArea: { width: '85%', height: '65%' },
          legend: { position: 'bottom' },
          hAxis: {
            title: '‡πÄ‡∏ß‡∏•‡∏≤',
            format: 'HH:mm',
            slantedText: true,
          },
          vAxes: {
            0: { title: 'Temp (¬∞C)' },
            1: { title: 'Humidity (%)' }
          },
          series: {
            0: { targetAxisIndex: 0, color: '#ff5252', lineWidth: 2 },
            1: { targetAxisIndex: 1, color: '#40c4ff', lineWidth: 2 }
          },
          height: 400,
          animation: { startup: true, duration: 500, easing: 'out' },
        };

        new google.visualization.LineChart(document.getElementById('chart_div')).draw(scrollData, options);
      });
    }
  </script>
  <style>
    body.dark {
      background-color: #121212;
      color: #eee;
    }
    body.light {
      background-color: #fff;
      color: #222;
    }
    body.blue {
      background-color: #e3f2fd;
      color: #0d47a1;
    }
    body.red {
      background-color: #ffebee;
      color: #b71c1c;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .description {
      margin-bottom: 15px;
    }
    #controls {
      margin-bottom: 15px;
    }
    #controls button {
      background: #1e88e5;
      border: none;
      padding: 8px 16px;
      color: #fff;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    #latestValues {
      display: flex;
      gap: 40px;
      margin: 20px 0;
    }
    .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    #chart_div {
      width: 100%;
      max-width: 900px;
    }
    #minMaxInfo {
      margin-top: 10px;
      font-size: 0.9rem;
      color: gray;
    }
    @media (max-width: 600px) {
      #latestValues {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body class="dark">
  <h1>üìä ESP8266 Temperature & Humidity Dashboard</h1>
  <p class="description">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
  <div id="controls" role="region" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">
    <button onclick="drawChart(1)">üìÖ 1 ‡∏ß‡∏±‡∏ô</button>
    <button onclick="drawChart(7)">üìÖ 7 ‡∏ß‡∏±‡∏ô</button>
    <button onclick="exportCSV()">üì§ Export CSV</button>
    <button onclick="setTheme('dark')">üåô Dark</button>
    <button onclick="setTheme('light')">üîÜ Light</button>
    <button onclick="setTheme('blue')">üîµ Blue</button>
    <button onclick="setTheme('red')">üî¥ Red</button>
  </div>
  <div id="latestValues" role="region" aria-live="polite">
    <div>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <span id="latestTemp" class="value">-- ¬∞C</span></div>
    <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: <span id="latestHum" class="value">-- %</span></div>
  </div>
  <div id="chart_div" role="img" aria-label="‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á"></div>
  <div id="minMaxInfo"></div>
</body>
</html>
