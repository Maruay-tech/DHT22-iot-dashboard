<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üå°Ô∏è Realtime Temperature & üíß Humidity (Last 3 Months)</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 1rem;
      background: #f9fbfc;
      color: #222;
    }
    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 2rem;
    }
    .chart-container {
      width: 100%;
      max-width: 430px;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    canvas {
      max-width: 100%;
      height: 250px;
    }
    .latest-values {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: #444;
      text-align: center;
    }
    @media (max-width: 600px) {
      #charts {
        flex-direction: column;
        align-items: center;
      }
      .chart-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>üå°Ô∏è Realtime Temperature & üíß Humidity (Last 3 Months)</h1>

  <div id="charts">
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
      <div id="latestTemp" class="latest-values">üå°Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥...</div>
    </div>
    <div class="chart-container">
      <canvas id="humChart"></canvas>
      <div id="latestHum" class="latest-values">üíß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô...</div>
    </div>
  </div>

  <script>
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Firebase config (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏Ñ‡∏∏‡∏ì)
    const firebaseConfig = {
      databaseURL: "https://esp8266-8198b-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Chart.js
    const ctxTemp = document.getElementById("tempChart").getContext("2d");
    const ctxHum = document.getElementById("humChart").getContext("2d");

    const tempChart = new Chart(ctxTemp, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Temperature (¬∞C)",
          data: [],
          borderColor: "#e25822",
          backgroundColor: "rgba(226, 88, 34, 0.3)",
          fill: true,
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time",
            time: {
              unit: "day",
              tooltipFormat: "DD MMM YYYY HH:mm"
            },
            title: { display: true, text: "‡πÄ‡∏ß‡∏•‡∏≤" }
          },
          y: {
            title: { display: true, text: "¬∞C" },
            suggestedMin: 10,
            suggestedMax: 50
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { mode: "index", intersect: false }
        }
      }
    });

    const humChart = new Chart(ctxHum, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Humidity (%)",
          data: [],
          borderColor: "#1f77b4",
          backgroundColor: "rgba(31, 119, 180, 0.3)",
          fill: true,
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time",
            time: {
              unit: "day",
              tooltipFormat: "DD MMM YYYY HH:mm"
            },
            title: { display: true, text: "‡πÄ‡∏ß‡∏•‡∏≤" }
          },
          y: {
            title: { display: true, text: "%" },
            suggestedMin: 10,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { mode: "index", intersect: false }
        }
      }
    });

    function tsToDate(ts) {
      return new Date(ts * 1000);
    }

    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏ö 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (90 ‡∏ß‡∏±‡∏ô)
    const threeMonthsAgo = Math.floor(Date.now() / 1000) - 90 * 24 * 60 * 60;

    function fetchData() {
      database.ref("logs").orderByKey().startAt(threeMonthsAgo.toString()).once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
          document.getElementById("latestTemp").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥";
          document.getElementById("latestHum").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô";
          return;
        }
        const tempLabels = [];
        const tempData = [];
        const humLabels = [];
        const humData = [];

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° timestamp (key)
        const entries = Object.entries(data).sort((a, b) => Number(a[0]) - Number(b[0]));

        entries.forEach(([ts, values]) => {
          const date = tsToDate(ts);
          tempLabels.push(date);
          tempData.push(values.temperature);
          humLabels.push(date);
          humData.push(values.humidity);
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
        tempChart.data.labels = tempLabels;
        tempChart.data.datasets[0].data = tempData;
        tempChart.update();

        humChart.data.labels = humLabels;
        humChart.data.datasets[0].data = humData;
        humChart.update();

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        const lastEntry = entries[entries.length - 1][1];
        document.getElementById("latestTemp").textContent = `üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastEntry.temperature.toFixed(2)} ¬∞C`;
        document.getElementById("latestHum").textContent = `üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastEntry.humidity.toFixed(2)} %`;
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
    fetchData();
    setInterval(fetchData, 60000);
  </script>
</body>
</html>
